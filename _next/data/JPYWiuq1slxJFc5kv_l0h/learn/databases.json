{"pageProps":{"post":{"title":"Databases","slug":"databases","content":"<h1>Databases</h1>\n<ul>\n<li>[x] MySQL + baked in spatial functions</li>\n<li>[ ] PostgreSQL + PostGIS</li>\n<li>[ ] SQLite + SpatiaLite</li>\n<li>[ ] DynamoDB</li>\n<li>[ ] Firebase</li>\n<li>[ ] MongoDB</li>\n<li>[ ] CouchDB</li>\n</ul>\n<h1>MySQL</h1>\n<ul>\n<li>Basic Docker stuff\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># show all running containers</span>\n$ docker <span class=\"token function\">ps</span>\n\n<span class=\"token comment\"># Show all stoped containers</span>\n$ docker <span class=\"token function\">ps</span> -a\n\n<span class=\"token comment\"># Pull the latest image</span>\n$ docker pull mysql/mysql-server:latest\n\n<span class=\"token comment\"># Create &#x26; run a container</span>\n$ docker run --name some-mysql -p <span class=\"token number\">3306</span>:3306  -e <span class=\"token assign-left variable\">MYSQL_ROOT_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token number\">123456789</span> -d mysql\n\n<span class=\"token comment\"># stop/start</span>\n$ docker stop some-mysql\n$ docker start some-mysql\n\n\n<span class=\"token comment\"># Docker cleanups</span>\n$ docker system prune\n$ docker image prune\n\n<span class=\"token comment\"># Create a database dump</span>\n$ docker <span class=\"token builtin class-name\">exec</span> some-mysql <span class=\"token function\">sh</span> -c <span class=\"token string\">'exec mysqldump --all-databases -uroot -p\"<span class=\"token variable\">$MYSQL_ROOT_PASSWORD</span>\"'</span> <span class=\"token operator\">></span> /some/path/on/your/host/all-databases.sql\n\n<span class=\"token comment\"># Restoring data from a dump file</span>\n$ docker <span class=\"token builtin class-name\">exec</span> -i some-mysql <span class=\"token function\">sh</span> -c <span class=\"token string\">'exec mysql -uroot -p\"<span class=\"token variable\">$MYSQL_ROOT_PASSWORD</span>\"'</span> <span class=\"token operator\">&#x3C;</span> /some/path/on/your/host/all-databases.sql\n</code></pre></div>\n</li>\n</ul>\n<h2>Connecting to your Database (MySQL v8)</h2>\n<ul>\n<li>\n<p>First spin up a docker container</p>\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Pull the latest image</span>\n$ docker pull mysql/mysql-server:latest\n\n<span class=\"token comment\"># Create &#x26; run a container</span>\n$ docker run --name some-mysql -p <span class=\"token number\">3306</span>:3306 -p <span class=\"token number\">33060</span>:33060  -e <span class=\"token assign-left variable\">MYSQL_ROOT_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token number\">123456789</span> -d mysql\n$ docker <span class=\"token builtin class-name\">exec</span> -it some-mysql mysql -uroot -p\nmysql<span class=\"token operator\">></span> CREATE DATABASE some-db<span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n<li>\n<p>Connecting to the <code>MySQL v8</code> Database with <a href=\"https://marketplace.visualstudio.com/items?itemName=mtxr.sqltools\"><code>SQLTools</code> extension</a>. You will also have to download the Extensions drivers: MySQL</p>\n<ul>\n<li><em>NOTE</em> we had to make a database <code>some-db</code> manually above\n<div class=\"remark-highlight\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"mysqlOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"authProtocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"xprotocol\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"previewLimit\"</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"server\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">33060</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"driver\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MySQL\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"MySQL_v8\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"database\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"some-db\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"root\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"password\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"123456789\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"connectionTimeout\"</span><span class=\"token operator\">:</span> <span class=\"token number\">15</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n</li>\n<li>Click the <code>Test Connection</code> (it kinda appears like a white rectanglar button)</li>\n<li>Under the <code>Connection</code> section in the side panel click this <code>some-mysql</code> connection and it will open up a sql window where you can write queries</li>\n<li>Use <code>--</code> to write comments &#x26; <code>-- @block</code> to write blocks that you can execute only the block</li>\n</ul>\n</li>\n<li>\n<p>Backing up data</p>\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># Create a database dump</span>\n$ docker <span class=\"token builtin class-name\">exec</span> some-mysql <span class=\"token function\">sh</span> -c <span class=\"token string\">'exec mysqldump --all-databases -uroot -p\"<span class=\"token variable\">$MYSQL_ROOT_PASSWORD</span>\"'</span> <span class=\"token operator\">></span> /some/path/on/your/host/all-databases.sql\n\n<span class=\"token comment\"># Restoring data from a dump file</span>\n$ docker <span class=\"token builtin class-name\">exec</span> -i some-mysql <span class=\"token function\">sh</span> -c <span class=\"token string\">'exec mysql -uroot -p\"<span class=\"token variable\">$MYSQL_ROOT_PASSWORD</span>\"'</span> <span class=\"token operator\">&#x3C;</span> /some/path/on/your/host/all-databases.sql\n</code></pre></div>\n</li>\n</ul>\n<h2>Docker Compose way</h2>\n<ul>\n<li>Where gonna use <code>docker-compose</code> to make our lives easier\n<ul>\n<li>Create a <code>docker-compose.yml</code> files with:\n<div class=\"remark-highlight\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.3'</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MYSQL_DATABASE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'some-db'</span>\n      <span class=\"token comment\"># So you don't have to use root, but you can if you like</span>\n      <span class=\"token key atrule\">MYSQL_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'user'</span>\n      <span class=\"token comment\"># You can use whatever password you like</span>\n      <span class=\"token key atrule\">MYSQL_PASSWORD</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'password'</span>\n      <span class=\"token comment\"># Password for root access</span>\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'password'</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># &#x3C;Port exposed> : &#x3C; MySQL Port running inside container></span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'3306:3306'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'33060:33060'</span>\n    <span class=\"token key atrule\">expose</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># Opens port 3306 on the container</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'3306'</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'33060'</span>\n      <span class=\"token comment\"># Where our data will be persisted</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> my<span class=\"token punctuation\">-</span>db<span class=\"token punctuation\">:</span>/var/lib/mysql\n      \n  <span class=\"token comment\"># http://localhost:8080/ to log into your DB</span>\n  <span class=\"token key atrule\">adminer</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> adminer\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 8080<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n      \n<span class=\"token comment\"># Names our volume</span>\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  my<span class=\"token punctuation\">-</span>db<span class=\"token punctuation\">:</span>\n</code></pre></div>\n</li>\n<li>Now we can run one command to get it all running:\n<div class=\"remark-highlight\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># build/run contains</span>\n$ docker-compose up\n\n<span class=\"token comment\"># stop all containers (for ctl+c twice)</span>\n$ docker-compose down\n\n<span class=\"token comment\"># Clean up everything</span>\n$ docker-compose down -v --rmi all --remove-orphans\n</code></pre></div>\n</li>\n</ul>\n</li>\n</ul>\n<h2>MySQL SQL Statements</h2>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> Users<span class=\"token punctuation\">(</span>\n  id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  email  <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">UNIQUE</span><span class=\"token punctuation\">,</span>\n  bio <span class=\"token keyword\">TEXT</span><span class=\"token punctuation\">,</span>\n  country <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> Users<span class=\"token punctuation\">(</span>\n  email<span class=\"token punctuation\">,</span>\n  bio<span class=\"token punctuation\">,</span>\n  country\n<span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token string\">'hello@world.com'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'I love strangers'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'US'</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> Users<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> Bookings<span class=\"token punctuation\">(</span>\n  id <span class=\"token keyword\">INT</span> <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  guest_id <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  room_id <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  start_date <span class=\"token keyword\">datetime</span><span class=\"token punctuation\">,</span>\n  end_date <span class=\"token keyword\">datetime</span><span class=\"token punctuation\">,</span>\n  price <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>\n  total <span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>\n  created_at <span class=\"token keyword\">datetime</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> Rooms<span class=\"token punctuation\">(</span>\n  owner_id <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  price <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  hot_tub <span class=\"token keyword\">boolean</span><span class=\"token punctuation\">,</span>\n  home_type <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span>\n  room_type <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span>\n  total_occupancy <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  total_bedrooms <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  total_bathrooms <span class=\"token keyword\">INT</span><span class=\"token punctuation\">,</span>\n  summary <span class=\"token keyword\">VARCHAR</span><span class=\"token punctuation\">(</span><span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  created_at <span class=\"token keyword\">datetime</span><span class=\"token punctuation\">,</span>\n  updated_at <span class=\"token keyword\">datetime</span><span class=\"token punctuation\">,</span>\n  latitude <span class=\"token keyword\">FLOAT</span><span class=\"token punctuation\">,</span>\n  longitude <span class=\"token keyword\">FLOAT</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2>MySQL with Spatial Data</h2>\n<ul>\n<li>\n<p><strong>MySQL <code>POINT(lng,lat)</code>, just like PostGIS maintains (lng,lat), however... the <code>ST_GeomFromText</code> like <code>ST_GeomFromText('POINT(45.5051 -122.6750)', 4326)</code> DOES <code>LAT/LNG</code>??</strong></p>\n</li>\n<li>\n<p>There is HUGE difference from MySQL v5.7 to v8.0</p>\n</li>\n<li>\n<p>Prior to v8 spatial data there wasn't multiple spatial reference systems and geographic computations all computations were Catesian</p>\n</li>\n<li>\n<p>So what is the least you need to know about??</p>\n<ul>\n<li>GIS libraries use <a href=\"https://epsg.io/\">EPSG</a> (EPSG actually stands for <code>European Petroleum Survey Group</code>) codes as Spatial Reference System Identifiers (SRIDs)</li>\n<li>All you need to know when working with spatial data on the web is most maps use the Spatial Reference System of <code>4326</code> which is <code>WGS 84 (Google Earth is in a Geographic coordinate system)</code></li>\n<li>Geospatial data is should be stored in internal geometry format either <code>Well-Known Text (WKT)</code> or <code>Well-Known Binary (WKB)</code> format.</li>\n</ul>\n</li>\n<li>\n<p><code>Point(X,Y)</code> is a constructor for numbers with precision and does not require converting first to text making it faster.</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- Slower</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> SOME_DB <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> coordinates<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Portland\"</span><span class=\"token punctuation\">,</span> ST_GeomFromText<span class=\"token punctuation\">(</span><span class=\"token string\">'POINT(45.5051 -122.6750)'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- Faster</span>\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> SOME_DB <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> coordinates<span class=\"token punctuation\">)</span> <span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Portland\"</span><span class=\"token punctuation\">,</span> ST_SRID<span class=\"token punctuation\">(</span><span class=\"token keyword\">POINT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">122.6750</span><span class=\"token punctuation\">,</span> <span class=\"token number\">45.5051</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n<li>\n<p>Let's define some points instead of 2 columns lat/long</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">`</span>places<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">unsigned</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span> <span class=\"token keyword\">varchar</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">`</span>coordinates<span class=\"token punctuation\">`</span> <span class=\"token keyword\">POINT</span> SRID <span class=\"token number\">4326</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">`</span>id<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n<li>\n<p>Let's create an idex</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> pt_idx <span class=\"token keyword\">ON</span> places<span class=\"token punctuation\">(</span>coordinates<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n<li>\n<p>Now let's add some points</p>\n<ul>\n<li><strong>NOTE</strong> the <code>POINT(LNG, LAT)</code> format</li>\n</ul>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> <span class=\"token punctuation\">`</span>places<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">`</span>coordinates<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Portland\"</span><span class=\"token punctuation\">,</span> ST_SRID<span class=\"token punctuation\">(</span><span class=\"token keyword\">POINT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">122.6795</span><span class=\"token punctuation\">,</span> <span class=\"token number\">45.52054</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> <span class=\"token punctuation\">`</span>places<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">`</span>coordinates<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Vancouver\"</span><span class=\"token punctuation\">,</span> ST_SRID<span class=\"token punctuation\">(</span><span class=\"token keyword\">POINT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">123.1207</span><span class=\"token punctuation\">,</span> <span class=\"token number\">49.2827</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> <span class=\"token punctuation\">`</span>places<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">`</span>coordinates<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Seattle\"</span><span class=\"token punctuation\">,</span> ST_SRID<span class=\"token punctuation\">(</span><span class=\"token keyword\">POINT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">122.33551</span><span class=\"token punctuation\">,</span> <span class=\"token number\">47.604311</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> <span class=\"token punctuation\">`</span>places<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">`</span>coordinates<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"San Francisco\"</span><span class=\"token punctuation\">,</span> ST_SRID<span class=\"token punctuation\">(</span><span class=\"token keyword\">POINT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">122.416534</span><span class=\"token punctuation\">,</span> <span class=\"token number\">37.771800273</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">INSERT</span> <span class=\"token keyword\">INTO</span> <span class=\"token punctuation\">`</span>places<span class=\"token punctuation\">`</span> <span class=\"token punctuation\">(</span> <span class=\"token punctuation\">`</span>name<span class=\"token punctuation\">`</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">`</span>coordinates<span class=\"token punctuation\">`</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">VALUES</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"Ottawa\"</span><span class=\"token punctuation\">,</span> ST_SRID<span class=\"token punctuation\">(</span><span class=\"token keyword\">POINT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">75.697174</span><span class=\"token punctuation\">,</span> <span class=\"token number\">45.42062</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n<li>\n<p>Select Data</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>  id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> ST_AsText<span class=\"token punctuation\">(</span>coordinates<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> places<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span>  id<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> ST_AsGeoJSON<span class=\"token punctuation\">(</span>coordinates<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> places<span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n<li>\n<p>Calculate distances</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- Distance from the montreal</span>\n<span class=\"token keyword\">SELECT</span> name<span class=\"token punctuation\">,</span>\nST_Distance_Sphere<span class=\"token punctuation\">(</span>coordinates<span class=\"token punctuation\">,</span> ST_SRID<span class=\"token punctuation\">(</span><span class=\"token keyword\">POINT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">73.6049652</span><span class=\"token punctuation\">,</span> <span class=\"token number\">45.503459</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> places<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">-- Distance less that 500Km (500000m) from the montreal </span>\n<span class=\"token keyword\">SELECT</span> name <span class=\"token keyword\">FROM</span> places\n<span class=\"token keyword\">WHERE</span> ST_Distance_Sphere<span class=\"token punctuation\">(</span>coordinates<span class=\"token punctuation\">,</span> ST_SRID<span class=\"token punctuation\">(</span><span class=\"token keyword\">POINT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">73.6049652</span><span class=\"token punctuation\">,</span> <span class=\"token number\">45.503459</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token number\">4326</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&#x3C;</span> <span class=\"token number\">500000</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n<li>\n<p>Selects all points in a polygon</p>\n</li>\n<li>\n<p>If you look closer, you’ll notice that the last point is the same as the first one and we have 5 points. This is because we need to “close” the polygon.</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token variable\">@polygon</span> <span class=\"token operator\">=</span> ST_SRID<span class=\"token punctuation\">(</span>\n  ST_GeomFromText<span class=\"token punctuation\">(</span><span class=\"token string\">'POLYGON(( -125.903320 44.668, -119.22 44.668, -119.22 50.2612, -125.903320 50.2612, -125.903320 44.668))'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token number\">4326</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span>  <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> ST_AsText<span class=\"token punctuation\">(</span>coordinates<span class=\"token punctuation\">)</span>  <span class=\"token keyword\">FROM</span> places <span class=\"token keyword\">WHERE</span> ST_CONTAINS<span class=\"token punctuation\">(</span><span class=\"token variable\">@polygon</span><span class=\"token punctuation\">,</span> coordinates<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n<li>\n<p>Get the result as GeoJson</p>\n<div class=\"remark-highlight\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token variable\">@polygon</span> <span class=\"token operator\">=</span> ST_SRID<span class=\"token punctuation\">(</span>\n  ST_GeomFromText<span class=\"token punctuation\">(</span><span class=\"token string\">'POLYGON(( </span>\n<span class=\"token string\">    -129.24316 43.16512263,</span>\n<span class=\"token string\">    -116.455078125 43.16512263,</span>\n<span class=\"token string\">    -116.455078125 52.24125614,</span>\n<span class=\"token string\">    -129.24316 52.24125614,</span>\n<span class=\"token string\">    -129.24316 43.165</span>\n<span class=\"token string\">  ))'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token number\">4326</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> json_merge<span class=\"token punctuation\">(</span>\n  json_object<span class=\"token punctuation\">(</span> <span class=\"token string\">\"type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"FeatureCollection\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  json_object<span class=\"token punctuation\">(</span> <span class=\"token string\">\"features\"</span><span class=\"token punctuation\">,</span> \n    json_arrayagg<span class=\"token punctuation\">(</span>\n      json_merge<span class=\"token punctuation\">(</span>\n        json_object<span class=\"token punctuation\">(</span> <span class=\"token string\">\"type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Feature\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        json_object<span class=\"token punctuation\">(</span> <span class=\"token string\">\"properties\"</span><span class=\"token punctuation\">,</span>  \n          json_merge<span class=\"token punctuation\">(</span>\n            json_object<span class=\"token punctuation\">(</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            json_object<span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        json_object<span class=\"token punctuation\">(</span><span class=\"token string\">'geometry'</span><span class=\"token punctuation\">,</span> ST_AsGeoJSON<span class=\"token punctuation\">(</span>coordinates<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> \n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> places <span class=\"token keyword\">WHERE</span> ST_CONTAINS<span class=\"token punctuation\">(</span><span class=\"token variable\">@polygon</span><span class=\"token punctuation\">,</span> coordinates<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n</li>\n</ul>\n","ogImage":{"url":"/assets/blog/hello-world/cover.jpg"},"coverImage":"/assets/blog/hello-world/cover.jpg"}},"__N_SSG":true}